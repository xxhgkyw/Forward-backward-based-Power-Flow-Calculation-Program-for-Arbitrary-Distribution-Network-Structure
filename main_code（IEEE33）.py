# 主脚本,求解IEEE 33节点的潮流：https://github.com/MATPOWER/matpower/blob/master/data/case33mg.m
# 全程采用标幺值计算,基值：SB=10MVA,VB=12.66kV=>ZB=16.02756Ω
# 首节点电压为12.66kV,其余节点初始电压不妨按0.95(p.u.)参与计算

import numpy as np
import supplement_code

# 33节点算例的节点负荷、支路阻抗信息
# 【注意】这里的负荷需要人为合并对地并联支路！
# IEEE33节点算例忽略了支路对地并联支路,故直接用负荷没问题
load_information = np.array([
    [1, 0.0, 0.0],
    [2, 0.1, 0.06],      # 【原来是1.0,0.6】
    [3, 0.09, 0.04],
    [4, 0.12, 0.08],
    [5, 0.06, 0.03],
    [6, 0.06, 0.02],
    [7, 0.2, 0.1],
    [8, 0.2, 0.1],
    [9, 0.06, 0.02],
    [10, 0.06, 0.02],
    [11, 0.045, 0.03],
    [12, 0.06, 0.035],
    [13, 0.06, 0.035],
    [14, 0.12, 0.08],
    [15, 0.06, 0.01],
    [16, 0.06, 0.02],
    [17, 0.06, 0.02],
    [18, 0.09, 0.04],
    [19, 0.09, 0.04],     # 19号节点
    [20, 0.09, 0.04],     # 20号节点
    [21, 0.09, 0.04],     # 21号节点
    [22, 0.09, 0.04],     # 22号节点
    [23, 0.09, 0.05],     # 23号节点
    [24, 0.42, 0.2],        # 24号节点【最早是4.2,2】
    [25, 0.42, 0.2],       # 25号节点【最早是4.2,2】
    [26, 0.06, 0.025],
    [27, 0.06, 0.025],
    [28, 0.06, 0.02],
    [29, 0.12, 0.07],
    [30, 0.2, 0.6],
    [31, 0.15, 0.07],
    [32, 0.21, 0.1],
    [33, 0.06, 0.04]
])  # 完全按照matpower数据(单位是MW)
load_information[:, 1:3] = load_information[:, 1:3] / 10    # 取标幺值
branch_matrix_33bus = np.array([
    [1, 2, 0.0922, 0.047],
    [2, 3, 0.493, 0.2511],
    [3, 4, 0.366, 0.1864],
    [4, 5, 0.3811, 0.1941],
    [5, 6, 0.819, 0.707],
    [6, 7, 0.1872, 0.6188],
    [7, 8, 0.7114, 0.2351],
    [8, 9, 1.03, 0.74],
    [9, 10, 1.044, 0.74],
    [10, 11, 0.1966, 0.065],
    [11, 12, 0.3744, 0.1238],
    [12, 13, 1.468, 1.155],
    [13, 14, 0.5416, 0.7129],
    [14, 15, 0.591, 0.526],
    [15, 16, 0.7463, 0.545],
    [16, 17, 1.289, 1.721],
    [17, 18, 0.732, 0.574],
    [2, 19, 0.164, 0.1565],
    [19, 20, 1.5042, 1.3554],
    [20, 21, 0.4095, 0.4784],
    [21, 22, 0.7089, 0.9373],
    [3, 23, 0.4512, 0.3083],
    [23, 24, 0.898, 0.7091],
    [24, 25, 0.896, 0.7011],
    [6, 26, 0.203, 0.1034],
    [26, 27, 0.2842, 0.1447],
    [27, 28, 1.059, 0.9337],
    [28, 29, 0.8042, 0.7006],
    [29, 30, 0.5075, 0.2585],
    [30, 31, 0.9744, 0.963],
    [31, 32, 0.3105, 0.3619],
    [32, 33, 0.341, 0.5302]
])  # 完全按照matpower数据(单位是Ω)
branch_matrix_33bus[:, 2:4] = branch_matrix_33bus[:, 2:4] / 16.02756    # 取标幺值

# 设置收敛精度
episilon = 1e-8

# 初始化实例
calculator = supplement_code.PowerFlowCalculator(branch_matrix_33bus, load_information, episilon)
V, angle, Sij = calculator.Power_flow_calculation()
print(V)
print(angle)
print(Sij)
